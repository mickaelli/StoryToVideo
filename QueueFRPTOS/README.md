# Remote Storyboard System (QueueFRPTOS)

**åŸºäº Go (Gin) å’Œ Python (FastAPI) æ„å»ºçš„è¿œç¨‹åˆ†é•œç”Ÿæˆç³»ç»Ÿ**

## ğŸŒŸ æ ¸å¿ƒåŠŸèƒ½

  * **ä»»åŠ¡é˜Ÿåˆ—**ï¼šä½¿ç”¨ **Redis + Asynq** å®ç°å¼‚æ­¥ä»»åŠ¡è°ƒåº¦ï¼Œé˜²æ­¢é«˜å¹¶å‘å¯¼è‡´ç³»ç»Ÿå¡æ­»ã€‚
  * **å†…ç½‘ç©¿é€**ï¼šé€šè¿‡ **FRP** å°†æœ¬åœ° GPU æœºå™¨ä¸Šçš„ Python Worker æš´éœ²ç»™äº‘ç«¯ Go Server è°ƒç”¨ã€‚
  * **åˆ†é•œç”Ÿæˆ**ï¼š
      * **Storyboard Mode**: æ¨¡æ‹Ÿ/è°ƒç”¨ LLM å°†æ•…äº‹æ–‡æœ¬æ‹†è§£ä¸ºåˆ†é•œåˆ—è¡¨ã€‚
      * **Shot Gen Mode**: å•ä¸ªåˆ†é•œçš„å›¾åƒç”Ÿæˆï¼ˆæ¨¡æ‹Ÿ SD/MJ ç»˜å›¾ï¼‰ã€‚
  * **äº‘ç«¯å­˜å‚¨**ï¼šç”Ÿæˆçš„å›¾ç‰‡å’Œè„šæœ¬è‡ªåŠ¨ä¸Šä¼ è‡³å…¼å®¹ S3 åè®®çš„å¯¹è±¡å­˜å‚¨ï¼ˆå¦‚ç«å±±å¼•æ“ TOSã€AWS S3ï¼‰ã€‚

## ğŸ“‚ ç›®å½•ç»“æ„

```text
QueueFRPTOS/
â”œâ”€â”€ config.yaml              # Go åç«¯é…ç½®æ–‡ä»¶ (æ•°æ®åº“, Redis, Workeråœ°å€)
â”œâ”€â”€ main.go                  # Go åç«¯å…¥å£
â”œâ”€â”€ go.mod / go.sum          # Go ä¾èµ–ç®¡ç†
â”œâ”€â”€ controllers/             # HTTP æ¥å£æ§åˆ¶å™¨
â”œâ”€â”€ models/                  # GORM æ•°æ®åº“æ¨¡å‹
â”œâ”€â”€ service/                 # ä¸šåŠ¡é€»è¾‘ (ä»»åŠ¡é˜Ÿåˆ—ç”Ÿäº§è€…/æ¶ˆè´¹è€…)
â”œâ”€â”€ python_worker/           # [æœ¬åœ°ç«¯] Python AI ç”ŸæˆæœåŠ¡
â”‚   â”œâ”€â”€ server.py            # FastAPI æœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ uploader.py          # S3/TOS æ–‡ä»¶ä¸Šä¼ å·¥å…·
â”‚   â””â”€â”€ .env                 # Python ç¯å¢ƒå˜é‡ (AK/SK)
â””â”€â”€ frp_config/              # FRP å†…ç½‘ç©¿é€é…ç½®
    â”œâ”€â”€ server/              # [äº‘ç«¯] frps é…ç½®
    â””â”€â”€ local/               # [æœ¬åœ°ç«¯] frpc é…ç½®
```

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡

### 1\. åŸºç¡€ç»„ä»¶

  * **Redis**: å¿…é¡»å®‰è£…å¹¶å¯åŠ¨ï¼ˆç”¨äºä»»åŠ¡é˜Ÿåˆ—ï¼‰ã€‚
  * **Database**: SQLite (é»˜è®¤) æˆ– MySQLã€‚
  * **FRP**: ç”¨äºè¿æ¥æœåŠ¡ç«¯å’Œæœ¬åœ° Workerã€‚

### 2\. è¯­è¨€ç¯å¢ƒ

  * **Go**: 1.18+
  * **Python**: 3.9+

-----

## ğŸš€ å¿«é€Ÿå¯åŠ¨æŒ‡å—

### ç¬¬ä¸€æ­¥ï¼šé…ç½®ä¸å¯åŠ¨ FRP (å†…ç½‘ç©¿é€)

ä¸ºäº†è®© Go åç«¯èƒ½è®¿é—®åˆ°ä½ æœ¬åœ°çš„ Python Workerï¼Œéœ€è¦å…ˆå»ºç«‹éš§é“ã€‚

**1. æœåŠ¡ç«¯ (äº‘ç«¯/Host):**

  * ä¿®æ”¹ `frp_config/server/.env.template`ã€‚
  * è¿è¡Œå¯åŠ¨è„šæœ¬ï¼š
    ```bash
    ./start.sh
    ```

**2. æ¨ç†ç«¯ (æœ¬åœ° GPU æœºå™¨):**

  * ä¿®æ”¹ `frp_config/local/.env.template`ï¼Œå¡«å…¥æœåŠ¡å™¨ IP å’Œ Tokenã€‚
  * è¿è¡Œå¯åŠ¨è„šæœ¬ï¼š
    ```powershell
    ./start_frpc_worker.ps1
    ```

> **âš ï¸ æ³¨æ„**ï¼šç¡®ä¿ `config.yaml` ä¸­çš„ `worker.addr` ä¸ FRP æ˜ å°„åçš„æœ¬åœ°è®¿é—®åœ°å€ä¸€è‡´ï¼ˆé€šå¸¸æ˜¯ `http://127.0.0.1:6000/generate`ï¼‰ã€‚

### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨ Python Worker (æœ¬åœ°ç«¯)

Worker è´Ÿè´£å®é™…çš„â€œç”Ÿæˆâ€é€»è¾‘ã€‚

1.  è¿›å…¥ç›®å½•ï¼š
    ```bash
    cd python_worker
    ```
2.  å®‰è£…ä¾èµ–ï¼š
    ```bash
    pip install fastapi uvicorn boto3 python-dotenv pydantic
    ```
3.  é…ç½®ç¯å¢ƒå˜é‡ï¼š
    å¤åˆ¶ `python_worker/.env.template` ä¸º `.env`ï¼Œå¹¶å¡«å…¥å¯¹è±¡å­˜å‚¨ï¼ˆS3/TOSï¼‰Access Key ä¿¡æ¯ã€‚
4.  å¯åŠ¨æœåŠ¡ï¼š
    ```bash
    python server.py
    ```
    *é»˜è®¤ç›‘å¬ 8080 ç«¯å£ï¼Œè¯¥ç«¯å£ä¼šè¢« FRP è½¬å‘ã€‚*

### ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨ Go Backend (æœåŠ¡ç«¯)

åç«¯è´Ÿè´£ API å“åº”å’Œä»»åŠ¡è°ƒåº¦ã€‚

1.  æ ¹ç›®å½•ä¸‹é…ç½® `config.yaml`:
      * ç¡®è®¤ `redis.addr` æ­£ç¡®ã€‚
      * ç¡®è®¤ `worker.addr` æŒ‡å‘äº† FRP æ˜ å°„çš„åœ°å€ï¼ˆä¾‹å¦‚ `http://127.0.0.1:6000/generate`ï¼‰ã€‚
2.  å®‰è£…ä¾èµ–å¹¶è¿è¡Œï¼š
    ```bash
    go mod tidy
    go run main.go
    ```

-----

## ğŸ“¡ API æ¥å£è¯´æ˜

æœåŠ¡å¯åŠ¨åé»˜è®¤è¿è¡Œåœ¨ `:8080` (Go Server)ã€‚

### 1\. åˆ›å»ºé¡¹ç›®

  * **URL**: `POST /api/projects`
  * **Body**:
    ```json
    {
      "title": "é¡¹ç›®æ ‡é¢˜",
      "story_text": "è¿™é‡Œæ˜¯æ•…äº‹æ–‡æœ¬...",
      "style": "é£æ ¼(å¦‚ movie/animation)"
    }
    ```
  * **å“åº”**: è¿”å›åˆ›å»ºæˆåŠŸçš„å®Œæ•´é¡¹ç›®å¯¹è±¡ï¼ˆåŒ…å«ç”Ÿæˆçš„ idï¼‰ã€‚

### 2\. ç”Ÿæˆåˆ†é•œ (Storyboard Task)

  * **åŠŸèƒ½**: ä¸ºæŒ‡å®šé¡¹ç›®è§¦å‘åˆ†é•œç”Ÿæˆä»»åŠ¡ã€‚
  * **URL**: `POST /api/projects/:project_id/generate-storyboard`
  * **Body**:
    ```json
    {
      "style": "",
      "story_text": ""
    }
    ```
  * **é€»è¾‘**:
    1.  æ ¹æ® `project_id` æŸ¥æ‰¾é¡¹ç›®ã€‚
    2.  åˆ›å»ºä¸€ä¸ªç±»å‹ä¸º `storyboard` çš„æ–°ä»»åŠ¡ã€‚
    3.  å‘é€ç»™ Worker çš„å‚æ•°:
          * `style`: æ¥è‡ªé¡¹ç›®çš„ style å­—æ®µã€‚
          * `story_text`: æ¥è‡ªé¡¹ç›®çš„ story\_text å­—æ®µã€‚
          * `need_images`: å›ºå®šä¸º `true`ã€‚
  * **å“åº”**:
    ```json
    {
      "message": "Task queued successfully",
      "task_id": "ç”Ÿæˆçš„ä»»åŠ¡UUID",
      "status": "pending"
    }
    ```

### 3\. ç”Ÿæˆå•å›¾ (Shot Generation)

  * **åŠŸèƒ½**: é‡æ–°ç”ŸæˆæŸä¸ªå…·ä½“åˆ†é•œçš„å›¾ç‰‡ã€‚
  * **URL**: `POST /api/shots/:shot_id/generate`
  * **Body**:
    ```json
    {
      "prompt": "Cyberpunk city street, raining",
      "style": "anime"
    }
    ```
  * **é€»è¾‘**:
    1.  æ ¹æ® `shot_id` æŸ¥æ‰¾åˆ†é•œï¼Œå¹¶æ‰¾åˆ°å…¶æ‰€å±é¡¹ç›®ã€‚
    2.  åˆ›å»ºä¸€ä¸ªç±»å‹ä¸º `shot_generation` çš„æ–°ä»»åŠ¡ã€‚
    3.  å‘é€ç»™ Worker çš„å‚æ•°:
          * `prompt`: ç›´æ¥ä½¿ç”¨è¯¥åˆ†é•œè®°å½•ä¸­çš„ Prompt å­—æ®µã€‚
          * `style`: ä½¿ç”¨æ‰€å±é¡¹ç›®çš„ Styleã€‚
  * **å“åº”**:
    ```json
    {
      "message": "Task queued successfully",
      "task_id": "ç”Ÿæˆçš„ä»»åŠ¡UUID",
      "status": "pending"
    }
    ```

### 4\. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

  * **URL**: `GET /api/tasks/:task_id`

-----

## â˜ï¸ äº‘ç«¯å­˜å‚¨ (TOS/S3) 

ç³»ç»Ÿå°è£…äº†ä¸€ä¸ª `TosUploader` ç±»ï¼Œåº•å±‚ä½¿ç”¨äº† AWS çš„ `boto3` åº“ã€‚

  * **åˆå§‹åŒ– (`init`)**:

      * ä»ç¯å¢ƒå˜é‡ (`.env`) è¯»å– `ACCESS_KEY`, `SECRET_KEY`, `ENDPOINT` (TOS çš„è®¿é—®åœ°å€), `TOS_BUCKET` (å­˜å‚¨æ¡¶å)ã€‚
      * å»ºç«‹ S3 å®¢æˆ·ç«¯è¿æ¥ã€‚

  * **æ–‡ä»¶ä¸Šä¼ ä¸é‰´æƒ (`upload_file`)**:

      * **ä¸Šä¼ **: ä½¿ç”¨ `self.s3.upload_fileobj` å°†æœ¬åœ°æ–‡ä»¶æµå†™å…¥äº‘ç«¯ã€‚
      * **ç­¾å**: ç”±äºå­˜å‚¨æ¡¶è®¾ç½®ä¸ºâ€œç§æœ‰è¯»â€ï¼Œç³»ç»Ÿä½¿ç”¨äº† **é¢„ç­¾å URL (Presigned URL)** æœºåˆ¶ã€‚
      * `generate_presigned_url` ä¼šç”Ÿæˆä¸€ä¸ªå¸¦æœ‰æ—¶æ•ˆæ€§çš„ URLã€‚å‰ç«¯ä½¿ç”¨è¿™ä¸ª URL å¯ä»¥åœ¨ä¸æš´éœ²å¯†é’¥çš„æƒ…å†µä¸‹ä¸´æ—¶ä¸‹è½½æˆ–æŸ¥çœ‹æ–‡ä»¶ã€‚
